<html>
<head>
<meta charset="utf-8">

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5W8DZRW');</script>
<!-- End Google Tag Manager -->

<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<link rel="Shortcut Icon" href="/assets/images/favicon.ico" type="image/x-icon"/>
<link rel="apple-touch-icon" href="/assets/images/apple-touch-icon.png"/>
<link rel="apple-touch-icon" sizes="72x72"
      href="/assets/images/apple-touch-icon-72x72.png"/>
<link rel="apple-touch-icon" sizes="114x114"
      href="/assets/images/apple-touch-icon-114x114.png"/>
<link rel="apple-touch-icon" sizes="144x144"
      href="/assets/images/apple-touch-icon-144x144.png"/>
<link rel="stylesheet" href="/0_assets/styles.css">


<!-- Social Media tag Starts -->
<!-- Place this data between the <head> tags of your website -->
<!-- Open Graph data -->
<meta property="og:title" content=""/>
<meta property="og:type" content="website"/>
<meta property="og:url" content="https://www.kotlincn.net/docs/tutorials/native/dynamic-libraries.html"/>
<meta property="og:image" content="https://www.kotlincn.net/assets/images/open-graph/kotlin_250x250.png"/>
    <meta property="og:description" content="Compiling Kotlin/Native code to a dynamic library">
<meta property="og:site_name" content="Kotlin"/>

<!-- Twitter Card data -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@kotlin">
<meta name="twitter:title" content="">
    <meta name="twitter:description" content="Compiling Kotlin/Native code to a dynamic library">
<meta name="twitter:image:src" content="https://www.kotlincn.net/assets/images/twitter-card/kotlin_800x320.png">
<!-- Social Media tag Ends -->

    <title>Kotlin/Native as a Dynamic Library - Kotlin 语言中文站</title>

    <script src="/0_assets/default.js"></script>
    <script src="/0_assets/common.js"></script>
    <link rel="stylesheet" href="/0_assets/default.css"/>
    <link rel="stylesheet" href="/0_assets/common.css"/>
</head>
<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5W8DZRW"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

<div class="global-layout">


<header class="global-header">

    <div class="global-header-panel">
        <div class="g-layout">
            <a class="global-header-logo" href="/">Kotlin</a>
<nav class="global-nav">
    <div class="nav-links">
            <a href="https://www.kotliner.cn/" class="nav-item">
                博客
            </a>
            <a href="https://discuss.kotliner.cn/" class="nav-item">
                论坛
            </a>
            <a href="/docs/reference/" class="nav-item">
                学习
            </a>
            <a href="/community/" class="nav-item">
                社区
            </a>
            <a href="http://try.kotlinlang.org" class="nav-item">
                在线试用
            </a>
    </div>

    <div class="search-button">
        <div class="icon"></div>
    </div>
</nav>        </div>
    </div>

    <div class="g-layout">
    </div>
</header>
    <div class="g-layout global-content">
        <nav class="docs-nav">
                <div class="nav-item-wrap">
                        <a href="/docs/reference/" class="nav-item">
                            <span class="nav-item-text">
                                参考
                            </span>
                        </a>
                </div>
                <div class="nav-item-wrap">
                        <a href="/docs/tutorials/" class="nav-item is_active">
                            <span class="nav-item-text">
                                教程
                            </span>
                        </a>
                </div>
                <div class="nav-item-wrap">
                        <a href="/docs/books.html" class="nav-item">
                            <span class="nav-item-text">
                                书籍
                            </span>
                        </a>
                </div>
                <div class="nav-item-wrap">
                        <a href="/docs/resources.html" class="nav-item">
                            <span class="nav-item-text">
                                更多资源
                            </span>
                        </a>
                </div>
        </nav>

    <div class="g-grid">
        <aside class="g-3">
            <div class="js-side-tree-nav">
                    <nav class="side-tree-nav">
                <div class="tree-item tree-branch js-item js-branch _opened"
         data-id="开始">

        <div class="tree-item-title tree-branch-title js-item-title js-branch-title is_active">
            <div class="marker"></div>
            <div class="text">开始</div>
        </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/getting-started.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">以 IntelliJ IDEA 入门</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/getting-started-eclipse.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">以 Eclipse 入门</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/command-line.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">使用命令行编译器</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/build-tools.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">使用构建工具</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/koans.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">心印</span>
            </a>
    </div>

    </div>

                <div class="tree-item tree-branch js-item js-branch _opened"
         data-id="Android">

        <div class="tree-item-title tree-branch-title js-item-title js-branch-title is_active">
            <div class="marker"></div>
            <div class="text">Android</div>
        </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/kotlin-android.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">Android 开发入门</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/android-plugin.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">Kotlin Android 扩展</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/android-frameworks.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">Android 框架</span>
            </a>
    </div>

    </div>

                <div class="tree-item tree-branch js-item js-branch _opened"
         data-id="Java 互操作">

        <div class="tree-item-title tree-branch-title js-item-title js-branch-title is_active">
            <div class="marker"></div>
            <div class="text">Java 互操作</div>
        </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/mixing-java-kotlin-intellij.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">在一个项目中混用 Java 与 Kotlin</span>
            </a>
    </div>

    </div>

                <div class="tree-item tree-branch js-item js-branch _opened"
         data-id="JavaScript">

        <div class="tree-item-title tree-branch-title js-item-title js-branch-title is_active">
            <div class="marker"></div>
            <div class="text">JavaScript</div>
        </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/javascript/kotlin-to-javascript/kotlin-to-javascript.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">Kotlin 转 JavaScript</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/javascript/getting-started-gradle/getting-started-with-gradle.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">以 Gradle 入门</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/javascript/getting-started-idea/getting-started-with-intellij-idea.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">以 IntelliJ IDEA 入门</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/javascript/getting-started-maven/getting-started-with-maven.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">以 Maven 入门</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/javascript/getting-started-command-line/command-line-library-js.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">使用命令行编译器创建 Kotlin JavaScript 库</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/javascript/working-with-modules/working-with-modules.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">Kotlin 与 JavaScript 模块使用</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/javascript/working-with-javascript.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">与 JavaScript 合用</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/javascript/debugging-javascript/debugging-javascript.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">在浏览器中调试 Kotlin</span>
            </a>
    </div>

    </div>

                <div class="tree-item tree-branch js-item js-branch _opened"
         data-id="原生">

        <div class="tree-item-title tree-branch-title js-item-title js-branch-title is_active">
            <div class="marker"></div>
            <div class="text">原生</div>
        </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/native/basic-kotlin-native-app.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">基本 Kotlin/Native 应用程序</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/native/interop-with-c.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">与 C 语言库互操作</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/native/mapping-primitive-data-types-from-c.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">映射来自 C 语言的原始数据类型</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/native/mapping-struct-union-types-from-c.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">映射来自 C 语言的结构与联合类型</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/native/mapping-function-pointers-from-c.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">映射来自 C 语言的函数指针</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/native/mapping-strings-from-c.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">映射来自 C 语言的字符串</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/native/working-with-klib.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">使用 Kotlin/Native 库</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/native/targeting-multiple-platforms.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">针对多平台</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <div class="tree-item-title tree-leaf-title js-item-title js-leaf-title is_active ">
                <div class="marker"></div>
                <div class="text">Kotlin/Native as a Dynamic Library</div>
            </div>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/native/apple-framework.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">Kotlin/Native as an Apple Framework</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/native/kotlin-native-with-clion.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">Kotlin/Native 使用 CLion</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/native/gradle-for-kotlin-native.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">Gradle 用于 Kotlin/Native</span>
            </a>
    </div>

    </div>

                <div class="tree-item tree-branch js-item js-branch _opened"
         data-id="协程">

        <div class="tree-item-title tree-branch-title js-item-title js-branch-title is_active">
            <div class="marker"></div>
            <div class="text">协程</div>
        </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/coroutines-basic-jvm.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">JVM 平台的 Kotlin 协程简介</span>
            </a>
    </div>

    </div>

                <div class="tree-item tree-branch js-item js-branch _opened"
         data-id="Web 开发">

        <div class="tree-item-title tree-branch-title js-item-title js-branch-title is_active">
            <div class="marker"></div>
            <div class="text">Web 开发</div>
        </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/httpservlets.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">用 Http Servlets 创建 web 应用</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/spring-boot-restful.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">用  Spring Boot 创建 RESTful Web 服务</span>
            </a>
    </div>

    </div>

                <div class="tree-item tree-branch js-item js-branch _opened"
         data-id="工具">

        <div class="tree-item-title tree-branch-title js-item-title js-branch-title is_active">
            <div class="marker"></div>
            <div class="text">工具</div>
        </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/kotlin-and-ci.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">TeamCity 配置 Kotlin</span>
            </a>
    </div>

    </div>

                <div class="tree-item tree-branch js-item js-branch _opened"
         data-id="教学">

        <div class="tree-item-title tree-branch-title js-item-title js-branch-title is_active">
            <div class="marker"></div>
            <div class="text">教学</div>
        </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/edu-tools-learner.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">通过 EduTools 插件学习 Kotlin</span>
            </a>
    </div>

                    <div class="tree-item tree-leaf js-item js-leaf ">
            <a href="/docs/tutorials/edu-tools-educator.html"
               class="tree-item-title tree-leaf-title js-item-title js-leaf-title "
            >
                <span class="marker"></span>
                <span class="text">通过 EduTools 插件讲授 Kotlin</span>
            </a>
    </div>

    </div>

    </nav>

            </div>
        </aside>

        <article role="main" class="page-content g-9">
<a href="https://github.com/hltj/kotlin-web-site-cn/edit/master/pages/docs/tutorials/native/dynamic-libraries.md"
   class="page-link-to-github"
   target="_blank"
   title="Edit this page on GitHub">
        <i class="github-icon"></i>
        <span class="text">Edit Page</span>
</a>
            <h1>
                Kotlin/Native as a Dynamic Library
            </h1>
            <table>
                    <tr>
                        <td>
                            <strong>最近更新</strong>
                        </td>
                        <td>
                            2018-08-05
                        </td>
                    </tr>
            </table>
                Compiling Kotlin/Native code to a dynamic library
                <br/>
                <br/>
            
<p>In this tutorial, we look at how we can use a Kotlin/Native code from
existing native applications or libraries. For this, we need to
compile our Kotlin code into a dynamic library, <code>.so</code>, <code>.dylib</code> and <code>.dll</code>.</p>
<p>Kotlin/Native also has tight integration with Apple technologies.
The <a href="apple-framework.html">Kotlin/Native as an Apple Framework</a>
tutorial explains how to compile Kotlin code into framework for Swift and Objective-C.</p>
<p>In this tutorial, we will:</p>
<ul>
<li><a href="#creating-a-kotlin-library">Compile a Kotlin code to a dynamic library</a></li>
<li><a href="#generated-headers-file">Examine generated C headers</a></li>
<li><a href="#using-generated-headers-from-c">Use the Kotlin dynamic library from C</a></li>
<li>Compile and run the example on <a href="#compiling-and-running-the-example-on-linux-and-macos">Linux and Mac</a>
and <a href="#compiling-and-running-the-example-on-windows">Windows</a></li>
</ul>
<h2 id="creating-a-kotlin-library">Creating a Kotlin Library</h2>
<p>Kotlin/Native compiler can produce a dynamic
library out of the Kotlin code we have.
A dynamic library often comes with a header file, an <code>.h</code> file,
which we will use to call compiled code from C</p>
<p>The best way to understand these techniques is to try them out. 
Let's create a tiny Kotlin library first and use it from a C program 
then.</p>
<p>We can start by creating a library file in Kotlin and save it as <code>lib.kt</code>:</p>
<div auto-indent="false" class="sample" data-highlight-only="1" mode="kotlin" theme="idea">
<pre><code class="language-kotlin">package example

object Object {
  val field = "A"
}

class Clazz {
  fun memberFunction(p: Int): ULong = 42UL
}

fun forIntegers(b: Byte, s: Short, i: UInt, l: Long) { }
fun forFloats(f: Float, d: Double) { }

fun strings(str: String) : String? {
  return "That is '$str' from C"
}

val globalString = "A global String"
</code></pre>
</div>
<p>We need to have a Kotlin/Native compiler on our machines.
More information on performing this step can be found in the
<a href="basic-kotlin-native-app.html#obtaining-the-compiler">A Basic Kotlin/Native Application</a>
tutorial.
Let's assume that we have a console, where the <code>kotlinc-native</code> command is available.</p>
<p>Now we can call the following command to compile the code into a dynamic library:</p>
<pre><code class="code _highlighted" data-lang="text/x-sh">kotlinc-native lib.kt -produce dynamic -output demo
</code></pre>
<p>The <code>kotlinc-native</code> (with v0.9.2) generates the following files, depending on the host OS:</p>
<ul>
<li>macOS: <code>demo_api.h</code> and <code>libdemo.dylib</code></li>
<li>Linux: <code>demo_api.h</code> and <code>libdemo.so</code></li>
<li>Windows: <code>demo_api.h</code>, <code>demo_symbols.def</code> and <code>demo.dll</code></li>
</ul>
<p>Let's check the C API for our Kotlin code in the <code>demo_api.h</code></p>
<h2 id="generated-headers-file">Generated Headers File</h2>
<p>In the <code>demo_api.h</code> (with Kotlin/Native v0.9.2) we'll find the following code. 
We will discuss the code in parts to make it easier to understand.</p>
<p>Note, the way Kotlin/Native exports symbols is subject to change without notice.</p>
<p>The very first part contains the standard C/C++ header and footer:</p>
<div auto-indent="false" class="sample" data-highlight-only="1" mode="C" theme="idea">
<pre><code class="language-c">#ifndef KONAN_DEMO_H
#define KONAN_DEMO_H
#ifdef __cplusplus
extern "C" {
#endif

/// THE REST OF THE GENERATED CODE GOES HERE

#ifdef __cplusplus
}  /* extern "C" */
#endif
#endif  /* KONAN_DEMO_H */
</code></pre>
</div>
<p>After the rituals in the <code>demo_api.h</code> we have a block with the common type definitions:</p>
<div auto-indent="false" class="sample" data-highlight-only="1" mode="C" theme="idea">
<pre><code class="language-c">#ifdef __cplusplus
typedef bool            demo_KBoolean;
#else
typedef _Bool           demo_KBoolean;
#endif
typedef unsigned short     demo_KChar;
typedef signed char        demo_KByte;
typedef short              demo_KShort;
typedef int                demo_KInt;
typedef long long          demo_KLong;
typedef unsigned char      demo_KUByte;
typedef unsigned short     demo_KUShort;
typedef unsigned int       demo_KUInt;
typedef unsigned long long demo_KULong;
typedef float              demo_KFloat;
typedef double             demo_KDouble;
typedef void*              demo_KNativePtr;
</code></pre>
</div>
<p>Kotlin uses the <code>demo_</code> prefix from the library name to make sure
the symbols will not clash with other symbols in the project.</p>
<p>The definitions part shows how Kotlin primitive types map into C primitive types. 
We discussed reverse mapping in the <a href="mapping-primitive-data-types-from-c.html">Mapping Primitive Data Types from C</a> tutorial.</p>
<p>The next part of the <code>demo_api.h</code> file contains definitions of types
that are used in the library:</p>
<div auto-indent="false" class="sample" data-highlight-only="1" mode="C" theme="idea">
<pre><code class="language-c">struct demo_KType;
typedef struct demo_KType demo_KType;

typedef struct {
  demo_KNativePtr pinned;
} demo_kref_example_DemoObject;

typedef struct {
  demo_KNativePtr pinned;
} demo_kref_example_DemoClazz;
</code></pre>
</div>
<p>The <code>typedef struct { .. } TYPE_NAME</code> syntax is used in C language to declare a structure. 
<a href="https://stackoverflow.com/questions/1675351/typedef-struct-vs-struct-definitions">The thread</a>
provides more explanations of that pattern.</p>
<p>We see from these definitions that the Kotlin object <code>DemoObject</code> is mapped into
<code>demo_kref_example_DemoObject</code> and <code>DemoClazz</code> is mapped into <code>demo_kref_example_DemoClazz</code>.
Both structs contain nothing but the <code>pinned</code> field with a pointer, the field type 
<code>demo_KNativePtr</code> is defined as <code>void*</code> above.</p>
<p>There is no namespaces support in C so that Kotlin/Native compiler generates 
long names to avoid a possible clashes with other symbols in existing native project.</p>
<p>The most significant part of definitions goes further in the <code>demo_api.h</code> file.
It includes the definition of our Kotlin/Native library world:</p>
<div auto-indent="false" class="sample" data-highlight-only="1" mode="C" theme="idea">
<pre><code class="language-c">typedef struct {
  /* Service functions. */
  void (*DisposeStablePointer)(demo_KNativePtr ptr);
  void (*DisposeString)(const char* string);
  demo_KBoolean (*IsInstance)(demo_KNativePtr ref, const demo_KType* type);

  /* User functions. */
  struct {
    struct {
      struct {
        void (*forIntegers)(demo_KByte b, demo_KShort s, demo_KUInt i, demo_KLong l);
        void (*forFloats)(demo_KFloat f, demo_KDouble d);
        const char* (*strings)(const char* str);
        const char* (*get_globalString)();
        struct {
          demo_KType* (*_type)(void);
          demo_kref_example_Object (*_instance)();
          const char* (*get_field)(demo_kref_example_Object thiz);
        } Object;
        struct {
          demo_KType* (*_type)(void);
          demo_kref_example_Clazz (*Clazz)();
          demo_KULong (*memberFunction)(demo_kref_example_Clazz thiz, demo_KInt p);
        } Clazz;
      } example;
    } root;
  } kotlin;
} demo_ExportedSymbols;
</code></pre>
</div>
<p>The code uses anonymous structure declarations. The code <code>struct { .. } foo</code>
declares a field in the outer struct of that 
anonymous structure type, the type with no name.</p>
<p>C does not support objects too. People use function pointers to mimic 
object semantics. A function pointer is declared as follows <code>RETURN_TYPE (* FIELD_NAME)(PARAMETERS)</code>.
It is tricky to read, but we should be able to see function pointer fields in the structures above.</p>
<h3 id="runtime-functions">Runtime Functions</h3>
<p>The code reads as follows. We have the <code>demo_ExportedSymbols</code> structure which defines
all the functions that Kotlin/Native and our library provides to us. It uses 
nested anonymous structures heavily to mimic packages. The <code>demo_</code> prefix comes from the
library name.</p>
<p>The <code>demo_ExportedSymbols</code> structure contains several helper functions:</p>
<div auto-indent="false" class="sample" data-highlight-only="1" mode="C" theme="idea">
<pre><code class="language-c">void (*DisposeStablePointer)(demo_KNativePtr ptr);
void (*DisposeString)(const char* string);
demo_KBoolean (*IsInstance)(demo_KNativePtr ref, const demo_KType* type);
</code></pre>
</div>
<p>These functions deal with Kotlin/Native objects. Call the 
<code>DisposeStablePointer</code> to release a Kotlin object and <code>DisposeString</code> to release Kotlin String, 
which has the <code>char*</code> type in C. It is possible to use the <code>IsInstance</code> function to check if a
Kotlin type or a <code>demo_KNativePtr</code> is an instance of another type. The actual set of
operations generated depend on the actual usages.</p>
<p>Kotlin/Native has garbage collection, but it does not help deal
with Kotlin objects from the C language. Kotlin/Native has interop with Objective-C and 
Swift and integrates with their reference counters. 
The <a href="/docs/reference/native/objc_interop.html">Objective-C Interop</a>
documentation article contains more more details on it. Also,
there is the related tutorial named <a href="apple-framework.html">Kotlin/Native as an Apple Framework</a>.</p>
<h3 id="our-library-functions">Our Library Functions</h3>
<p>Let's take a look an the <code>kotlin.root.example</code> field, it
mimics the package structure of our Kotlin code with a <code>kotlin.root.</code> prefix.</p>
<p>There is a <code>kotlin.root.example.Clazz</code> field that 
represents the <code>Clazz</code> from Kotlin. The <code>Clazz#memberFunction</code> is
accessible with the <code>memberFunction</code> field. The only difference is that 
the <code>memberFunction</code> accepts <code>this</code> reference as the first parameter. 
C language does not support objects, and that is the reason to pass a
<code>this</code> pointer explicitly.</p>
<p>There is a constructor in the <code>Clazz</code> field (aka <code>kotlin.root.example.Clazz.Clazz</code>),
which is the constructor function to create an instance of the <code>Clazz</code>.</p>
<p>Kotlin <code>object Object</code> is accessible as <code>kotlin.root.example.Object</code>. There is 
the <code>_instance</code> function to get the only instance of the object.</p>
<p>Properties are translated into functions. The <code>get_</code> and <code>set_</code> prefix
is used to name the getter and the setter functions respectively. For example, 
the read-only property <code>globalString</code> from Kotlin is turned 
into a <code>get_globalString</code> function in C.</p>
<p>Global functions <code>forInts</code>, <code>forFloats</code>, or <code>strings</code> are turned into the functions pointers in
the <code>kotlin.root.example</code> anonymous struct.</p>
<h3 id="the-entry-point">The Entry Point</h3>
<p>We can see how the API is created. To start with, we need to initialize the 
<code>demo_ExportedSymbols</code> structure. Let's take a look at the latest part 
of the <code>demo_api.h</code> for that:</p>
<pre><code class="code _highlighted" data-lang="text/x-csrc">extern demo_ExportedSymbols* demo_symbols(void);
</code></pre>
<p>The function <code>demo_symbols</code> allows us to open the door from the native 
code to the Kotlin/Native library. That is the entry point we use. The 
library name is used as a prefix for the function name.</p>
<p>Note, Kotlin/Native object references do not support multi-threaded access. 
Hosting the returned <code>demo_ExportedSymbols*</code> pointer
per thread might be necessary.</p>
<h2 id="using-generated-headers-from-c">Using Generated Headers from C</h2>
<p>The usage from C is straightforward and uncomplicated. We create a <code>main.c</code> file with the following 
code:</p>
<div auto-indent="false" class="sample" data-highlight-only="1" mode="C" theme="idea">
<pre><code class="language-c">#include "demo_api.h"
#include "stdio.h"

int main(int argc, char** argv) {
  //obtain reference for calling Kotlin/Native functions
  demo_ExportedSymbols* lib = demo_symbols();

  lib-&gt;kotlin.root.example.forIntegers(1, 2, 3, 4);
  lib-&gt;kotlin.root.example.forFloats(1.0f, 2.0);

  //use C and Kotlin/Native strings
  const char* str = "Hello from Native!";
  const char* response = lib-&gt;kotlin.root.example.strings(str);
  printf("in: %s\nout:%s\n", str, response);
  lib-&gt;DisposeString(response);

  //create Kotlin object instance
  demo_kref_example_Clazz newInstance = lib-&gt;kotlin.root.example.Clazz.Clazz();
  long x = lib-&gt;kotlin.root.example.Clazz.memberFunction(newInstance, 42);
  lib-&gt;DisposeStablePointer(newInstance.pinned);

  printf("DemoClazz returned %ld\n", x);

  return 0;
}
</code></pre>
</div>
<h2 id="compiling-and-running-the-example-on-linux-and-macos">Compiling and Running the Example on Linux and macOS</h2>
<p>On macOS 10.13 with Xcode, we compile the C code and link it with the dynamic library
with the following command:</p>
<pre><code class="code _highlighted" data-lang="text/x-sh">clang main.c libdemo.dylib
</code></pre>
<p>On Linux we call a similar command:</p>
<pre><code class="code _highlighted" data-lang="text/x-sh">gcc main.c libdemo.so
</code></pre>
<p>The compiler generates an executable called <code>a.out</code>. We need to run it to see Kotlin code
being executed from C library in action. On Linux, we'll need to include <code>.</code> into the <code>LD_LIBRARY_PATH</code>
to let the application know to load the <code>libdemo.so</code> library from the current folder.</p>
<h2 id="compiling-and-running-the-example-on-windows">Compiling and Running the Example on Windows</h2>
<p>To start with, we'll need a Microsoft Visual C++ compiler installed that supports a x64_64 
target. The easiest way to do this is to have a version of Microsoft Visual Studio installed on 
the Windows machine.</p>
<p>We will be using the <code>x64 Native Tools Command Prompt &lt;VERSION&gt;</code> console. We'll see the 
shortcut to open the console in the start menu. It comes with a Microsoft Visual Studio
package.</p>
<p>On Windows, Dynamic libraries are included either via a generated static library wrapper
or with manual code which deals with the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms684175.aspx">LoadLibrary</a>
or similar Win32API functions. We will follow the first option and generate the static wrapper library
for the <code>demo.dll</code> on our own.</p>
<p>We call <code>lib.exe</code> from the toolchain to generate the static library 
wrapper <code>demo.lib</code> that automates the DLL usage from the code:</p>
<pre><code class="code _highlighted" data-lang="text/x-sh">lib /def:demo_symbols.def /out:demo.lib
</code></pre>
<p>Now we are ready to compile our <code>main.c</code> into an executable. We include the generated <code>demo.lib</code> into
the build command and start:</p>
<pre><code class="code _highlighted" data-lang="text/x-sh">cl.exe main.c demo.lib
</code></pre>
<p>The command produces the <code>main.exe</code> file, which we can run.</p>
<h2 id="next-steps">Next Steps</h2>
<p>Dynamic libraries are the main ways to use Kotlin code from existing programs. 
We may use them to share our code with many platforms or languages, including JVM,
<a href="https://github.com/JetBrains/kotlin-native/blob/master/samples/python_extension/src/main/c/kotlin_bridge.c">Python</a>,
iOS, Android, and others.</p>
<p>Kotlin/Native also has tight integration with Objective-C and Swift.
It is covered in the <a href="apple-framework.html">Kotlin/Native as an Apple Framework</a>
tutorial.</p>

        </article>
    </div>
    </div>

</div>

<footer role="contentinfo" class="global-footer">

    <div class="global-footer-terms">
        <div class="g-layout">

            <div class="terms-copyright">
                采用 <a href="https://github.com/JetBrains/kotlin-web-site/blob/master/LICENSE">Apache 2 许可协议</a>
            </div>

            <div class="terms-sponsor">
            由 <a href="http://jetbrains.com" class="sponsor sponsor_jetbrains" target="_blank">JetBrains</a> 赞助及开发；
            由<a href="https://hltj.me/" class="testimonial-company-link" target="_blank" rel="nofollow">灰蓝天际</a>、<a href="http://tanfujun.com" class="testimonial-company-link" target="_blank" rel="nofollow">晓_晨DEV</a> <a href="/contribute.html#中文站翻译贡献者" class="testimonial-company-link" target="_blank" rel="nofollow">等</a>译
            </div>
        </div>
    </div>

</footer>
    <script src="/0_assets/tutorial.js"></script>
<div class="search-popup _hidden" tabindex="1000">
    <div class="search-popup__content">
        <div class="search-popup__controls">
            <div class="search-popup__input"></div>
            <div class="search-popup__close">
                <div class="search-popup__close-icon-wrapper">
                    <div class="search-popup__close-icon"></div>
                </div>
                <div class="search-popup__close-text">esc</div>
            </div>
        </div>
        <div class="search-popup__results"></div>
    </div>
</div></body>
</html>